<!DOCTYPE html>
<html>
<head>
    <title>Car Racer</title>
    <meta charset="utf-8">
    <script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function() {
            var then = Date.now();
            var gameStarted = false;
            var countdown = 3;
            var score = 0;

            // Initialize game
            function init() {
                countdownStart();
                setInterval(main, 20);
            }

            function countdownStart() {
                var countdownInterval = setInterval(function() {
                    canvas.clear();
                    ctx.font = "50px Helvetica";
                    ctx.fillStyle = "red";
                    ctx.textAlign = "center";
                    ctx.fillText(countdown > 0 ? countdown : "GO!", canvas.getCanvasWidth() / 2, canvas.getCanvasHeight() / 2);
                    countdown--;

                    if (countdown < -1) {
                        clearInterval(countdownInterval);
                        gameStarted = true;
                    }
                }, 1000);
            }

            function canvas() {
                var canvas = document.getElementById("race-track");
                var ctx = canvas.getContext("2d");

                var canvasWidth = ctx.canvas.clientWidth;
                var canvasHeight = ctx.canvas.clientHeight;

                this.getCtx = getCtx;
                this.getCanvasWidth = getCanvasWidth;
                this.getCanvasHeight = getCanvasHeight;

                function getCtx() {
                    return ctx;
                }

                function getCanvasWidth() {
                    return canvasWidth;
                }

                function getCanvasHeight() {
                    return canvasHeight;
                }

                this.clear = function() {
                    ctx.clearRect(0, 0, canvasWidth, canvasHeight);
                }
            }

            function main() {
                var now = Date.now();
                var fps = 1000 / (now - then);

                if (gameStarted) {
                    update();
                    render(fps);
                }

                then = now;
            }

            function update(modifier) {
                car1.calcPos(modifier);
                currentTileArray = car1.getTile(trackObj.tileWidth(), trackObj.tileHeight());
                score++;
            }

            function render(fps) {
                canvas.clear();
                renderMap(trackObj);
                car1.drawCar(ctx);
                hud(ctx, fps);
            }

            function renderMap(mapObj) {
                var rgt = mapObj.data();
                for (matrixY in rgt) {
                    for (matrixX in rgt[matrixY]) {
                        var matrixArray = rgt[matrixY][matrixX].split(',');
                        var x = matrixArray[1];
                        var y = matrixArray[0];
                        var sx = (x - 1) * mapObj.tileWidth();
                        var sy = (y - 1) * mapObj.tileHeight();
                        var dx = (matrixX) * mapObj.tileWidth();
                        var dy = (matrixY) * mapObj.tileHeight();

                        ctx.drawImage(mapObj.mapTilesImg(), sx, sy, mapObj.tileWidth(), mapObj.tileHeight(), dx, dy, mapObj.tileWidth(), mapObj.tileHeight());
                    }
                }
                // Draw yellow road stripes
                ctx.fillStyle = "yellow";
                ctx.fillRect(canvas.getCanvasWidth() / 2 - 2, 0, 4, canvas.getCanvasHeight());
            }

            function car(x, y, degrees, carObj) {
                var MAX_ACCEL = carObj.max_speed;
                var DRAG = carObj.drag;
                var carImage = new Image();
                carImage.src = carObj.image;

                var xPos = x;
                var yPos = y;
                var _accel = 0;
                var heading = degrees;

                var xVel = 0;
                var yVel = 0;

                this.drawCar = function(ctx) {
                    var transX = xPos - (carImage.width / 2);
                    var transY = yPos - (carImage.height / 2);

                    ctx.save();
                    ctx.translate(transX, transY);
                    ctx.rotate(heading);
                    ctx.drawImage(carImage, -carImage.width / 2, -carImage.height / 2);
                    ctx.restore();
                }

                this.calcPos = function() {
                    xVel *= (1 - DRAG);
                    yVel *= (1 - DRAG);

                    heading = (_rotation * Math.PI / 180);
                    xVel += MAX_ACCEL * _accel * Math.sin(heading);
                    yVel -= MAX_ACCEL * _accel * Math.cos(heading);

                    xPos += xVel;
                    yPos += yVel;
                }

                this.forwardOn = function() { _accel = 1; }
                this.forwardOff = function() { _accel = 0; }
                this.reverseOn = function() { _accel = -1; }
                this.reverseOff = function() { _accel = 0; }
                this.rightTurnOn = function() { _turn = 1; }
                this.rightTurnOff = function() { _turn = 0; }
                this.leftTurnOn = function() { _turn = -1; }
                this.leftTurnOff = function() { _turn = 0; }

                this.getTile = function(tileWidth, tileHeight) {
                    var tileX = Math.ceil(xPos / tileWidth);
                    var tileY = Math.ceil(yPos / tileHeight);
                }
            }

            function hud(ctx, fps) {
                ctx.fillStyle = "white";
                ctx.font = "18px Helvetica";
                ctx.fillText("Score: " + score, 20, 30);

                ctx.textAlign = "right";
                ctx.fillText("Speed: " + Math.round(Math.sqrt(xVel * xVel + yVel * yVel) * 100), canvas.getCanvasWidth() - 20, 30);
            }

            var canvas = new canvas();
            var ctx = canvas.getCtx();
            canvas.clear();

            var carImagePath = 'assets/car.jpg';  // Replace with your uploaded path in your repo
            var trackObj = new track(track1);
            x = trackObj.setStartPos()[0];
            y = trackObj.setStartPos()[1];
            direction = trackObj.setStartPos()[2];

            var car1 = new car(x, y, direction, { image: carImagePath, max_speed: 0.5, drag: 0.05 });
            init();

            $(document).keydown(onKeyDown);
            $(document).keyup(onKeyUp);
        });
    </script>
</head>
<body>
    <canvas id="race-track" width="768" height="640" style="border:1px solid black;"></canvas>
</body>
</html>
